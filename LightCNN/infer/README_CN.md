# LightCNN MindX推理及mx Base推理

<!-- TOC -->

- [脚本说明](#脚本说明)
    - [脚本及样例代码](#脚本及样例代码)
    - [数据集准备](#数据集准备)
    - [模型转换](#模型转换)
    - [MindX SDK 启动流程](#mindx-sdk-启动流程)
    - [mx Base 推理流程](#mx-base-推理流程)

<!-- /TOC -->

## 脚本说明

### 脚本及样例代码

```tex
├── lightcnn
    ├── README_CN.md                           // lightcnn 的说明文件
    ├── infer
        ├── README_CN.md                       // lightcnn 的 MindX SDK 推理及 mx Base 推理的说明文件
        ├── convert
        │   ├──convert_om.sh                 // 将 air 模型转换为 om 模型的脚本
        ├── model                            // 模型存放位置
        ├── mxbase                             // mx Base 推理目录（C++）
        │   ├──src
        │   │   ├──Lightcnn.h                     // 头文件
        │   │   ├──Lightcnn.cpp                   // 详细实现
        │   │   ├──main.cpp                    // mx Base 主函数
        │   ├──build.sh                        // 代码编译脚本
        │   ├──CMakeLists.txt                  // 代码编译设置
        ├── sdk
        │   ├──main.py                         // MindX SDK 运行脚本
        │   ├──ligthcnn.pipeline               // MindX SDK运行所需的 pipline 配置文件
    ├── ......                                 // 其他代码文件
```

### 数据集准备

测试集：LFW人脸数据集(Labeled Faces in the Wild)。LFW数据集共包含来自5749个人的13233张人脸图像。LightCNN原作者提供的对齐后的[测试集链接](https://pan.baidu.com/s/1eR6vHFO)。

测试集列表：原作者并未提供测试集列表，只能根据原作者给出的测试结果反推测试集列表。首先下载[blufr官方测试文件包](http://www.cbsr.ia.ac.cn/users/scliao/projects/blufr/BLUFR.zip)和[原作者测试结果](https://github.com/AlfredXiangWu/face_verification_experiment/blob/master/results/LightenedCNN_B_lfw.mat)，将`blufr官方测试文件包`解压的文件夹，与`原作者测试结果--LightenedCNN_B_lfw.mat`、`LightCNN/src/get_list.py`(本脚本提供)放在同一个目录内，运行`python get_list.py`，即可在`LightCNN/src/`下生成`image_list_for_lfw.txt`和`image_list_for_blufr.txt`。(模型推理采用image_list_for_lfw.txt)

### 模型转换

然后执行 convert 目录下的 convert_om.sh 将 air 模型文件转换为 om 模型文件以备后续使用。

```bash
cd /home/lightcnn/infer/convert
bash convert_om.sh [model] [output]
e.g.
bash convert_om.sh ../lightcnn4Test.air ../model/lightcnn
#转换后的模型结果为lightcnn4Test.om，将放在/home/lightcnn/infer/model/目录下
```

### MindX SDK 启动流程

```bash
# 通过 python 命令启动 MindX SDK 推理
python3.7 main.py
# 注意：main.py文件中pipeline配置文件以及数据集的位置应该改成实际路径
```

推理结果示例(第一张照片的推理结果):

```tex
[[30.453125, 6.8984375, 33.90625, 1.7998046875, 18.65625, -30.859375, -17.265625, -9.1796875, -28.625, 26.515625, 6.77734375, -11.015625, -1.31640625, -12.9140625, -11.7265625, 15.375, -13.8984375, -26.734375, 14.34375, -12.109375, -10.984375, 4.46875, -5.63671875, -2.349609375, 2.0078125, 9.34375, -4.890625, 11.4609375, 5.60546875, -4.12109375, -1.9384765625, 1.26171875, -5.48046875, -17.0, 27.5625, -30.484375, 2.8046875, 19.71875, -11.671875, -13.7109375, -8.5625, 24.265625, -9.28125, -30.953125, -5.23046875, -11.75, -11.953125, -30.328125, 9.4140625, 11.1171875, 18.78125, 2.587890625, 17.1875, 12.15625, 5.9453125, -31.09375, 12.7890625, -7.47265625, -14.2421875, 8.3671875, 9.953125, 17.21875, 3.166015625, 2.923828125, 9.359375, 22.859375, 20.09375, -23.484375, 25.328125, -1.611328125, 32.90625, 7.046875, -7.05859375, 7.48828125, 33.84375, -15.140625, -16.375, -0.02447509765625, -6.5703125, -21.953125, 29.9375, 23.28125, -25.015625, -2.87890625, 5.484375, 17.625, -8.9375, 15.5234375, -3.88671875, 11.1484375, 22.84375, 11.734375, 11.890625, -16.3125, 28.625, 11.4140625, 7.60546875, 29.609375, -0.10455322265625, -4.34765625, 13.609375, 6.1640625, -10.6875, 4.15625, -14.5703125, 0.7685546875, -15.125, 36.21875, -18.609375, 17.9375, 3.9921875, -4.8984375, -6.74609375, -5.20703125, -5.7421875, 4.83203125, 13.6796875, -13.6015625, 8.109375, -5.87109375, 11.5234375, 9.96875, -11.109375, 17.390625, -3.205078125, 29.984375, 5.05078125, 18.3125, 11.859375, 4.69921875, -0.46533203125, -7.5703125, 22.734375, 1.7685546875, -10.296875, 30.0625, 19.625, -26.140625, -33.03125, 4.16796875, 6.88671875, 21.46875, -14.625, -6.0078125, -16.078125, -16.453125, -26.375, 14.9765625, -13.96875, -18.765625, 6.859375, -7.65234375, 28.515625, 8.171875, 29.78125, 50.5625, -8.625, 6.40625, -20.953125, 8.75, 6.01171875, 4.3203125, -5.7265625, 13.3515625, 10.71875, 13.1640625, 2.734375, -8.6953125, -4.6328125, -22.765625, 4.6484375, 12.921875, -0.297119140625, -9.921875, -33.78125, -13.671875, 24.734375, 10.25, 9.6640625, -1.015625, 2.283203125, -1.0556640625, 23.78125, 20.859375, -29.625, -2.763671875, -1.9013671875, 15.1875, -21.03125, 13.5078125, 15.78125, 6.1875, 1.40234375, -20.515625, 31.953125, 2.8984375, 27.109375, 13.6875, -7.0625, 4.2265625, 4.984375, 8.265625, 14.625, -9.046875, -19.484375, -13.3046875, 9.46875, -9.3515625, -3.94921875, 3.5, -2.34375, 6.65234375, -14.6015625, -14.7265625, 23.84375, -0.4892578125, -17.921875, -24.28125, 0.921875, -5.3359375, -1.6064453125, 0.81201171875, 0.31103515625, -5.69140625, 20.953125, -14.7890625, -7.05859375, -11.5234375, 8.4140625, 7.69921875, 7.265625, 12.21875, -5.09375, 14.828125, -0.0019140243530273438, -4.203125, 13.6796875, -14.8125, -2.755859375, -8.3984375, 16.5, -3.236328125, -19.984375, 31.125, -5.69921875, -13.9921875, 10.2421875, -1.2763671875, 4.7578125, -17.3125, 15.984375, 0.24365234375, 0.26953125, -16.84375, -12.828125, 20.0]]
```

推理精度如下：

```pascal
100%eer:       98.67
tpr@far=1%:    98.5
tpr@far=0.1%:  94.6
tpr@far=0%:    89.13
```

### mx Base 推理流程

1、编译 mx Base

```bash
cd /home/lightcnn/infer/mxbase
bash build.sh
```

> **说明：**
> 编译成功后将在该路径（“/home/lightcnn/infer/mxbase”)下生成“build”目录，其中包含了编译好的可执行文件“lightcnn”。“/home/lightcnn/infer/mxbase”目录下的“lightcnn”也可直接运行，二者是一致的。

2、执行 mx Base 推理

```tex
./lightcnn  input_data_path
# 将需要测试的数据集的文件路径输入
例如：
 ./lightcnn input
```

**表 1**  参数说明

| 参数            | 说明                              |
| --------------- | --------------------------------- |
| input_data_path | 推理图片路径（图片要求为128*128） |

mx Base 推理结果示例：

以第一张图片推理结果为例：

```tex
30.4531 6.89844 33.9062 1.7998 18.6562 -30.8594 -17.2656 -9.17969 -28.625 26.5156 6.77734 -11.0156 -1.31641 -12.9141 -11.7266 15.375 -13.8984 -26.7344 14.3438 -12.1094 -10.9844 4.46875 -5.63672 -2.34961 2.00781 9.34375 -4.89062 11.4609 5.60547 -4.12109 -1.93848 1.26172 -5.48047 -17 27.5625 -30.4844 2.80469 19.7188 -11.6719 -13.7109 -8.5625 24.2656 -9.28125 -30.9531 -5.23047 -11.75 -11.9531 -30.3281 9.41406 11.1172 18.7812 2.58789 17.1875 12.1562 5.94531 -31.0938 12.7891 -7.47266 -14.2422 8.36719 9.95312 17.2188 3.16602 2.92383 9.35938 22.8594 20.0938 -23.4844 25.3281 -1.61133 32.9062 7.04688 -7.05859 7.48828 33.8438 -15.1406 -16.375 -0.0244751 -6.57031 -21.9531 29.9375 23.2812 -25.0156 -2.87891 5.48438 17.625 -8.9375 15.5234 -3.88672 11.1484 22.8438 11.7344 11.8906 -16.3125 28.625 11.4141 7.60547 29.6094 -0.104553 -4.34766 13.6094 6.16406 -10.6875 4.15625 -14.5703 0.768555 -15.125 36.2188 -18.6094 17.9375 3.99219 -4.89844 -6.74609 -5.20703 -5.74219 4.83203 13.6797 -13.6016 8.10938 -5.87109 11.5234 9.96875 -11.1094 17.3906 -3.20508 29.9844 5.05078 18.3125 11.8594 4.69922 -0.465332 -7.57031 22.7344 1.76855 -10.2969 30.0625 19.625 -26.1406 -33.0312 4.16797 6.88672 21.4688 -14.625 -6.00781 -16.0781 -16.4531 -26.375 14.9766 -13.9688 -18.7656 6.85938 -7.65234 28.5156 8.17188 29.7812 50.5625 -8.625 6.40625 -20.9531 8.75 6.01172 4.32031 -5.72656 13.3516 10.7188 13.1641 2.73438 -8.69531 -4.63281 -22.7656 4.64844 12.9219 -0.297119 -9.92188 -33.7812 -13.6719 24.7344 10.25 9.66406 -1.01562 2.2832 -1.05566 23.7812 20.8594 -29.625 -2.76367 -1.90137 15.1875 -21.0312 13.5078 15.7812 6.1875 1.40234 -20.5156 31.9531 2.89844 27.1094 13.6875 -7.0625 4.22656 4.98438 8.26562 14.625 -9.04688 -19.4844 -13.3047 9.46875 -9.35156 -3.94922 3.5 -2.34375 6.65234 -14.6016 -14.7266 23.8438 -0.489258 -17.9219 -24.2812 0.921875 -5.33594 -1.60645 0.812012 0.311035 -5.69141 20.9531 -14.7891 -7.05859 -11.5234 8.41406 7.69922 7.26562 12.2188 -5.09375 14.8281 -0.00191402 -4.20312 13.6797 -14.8125 -2.75586 -8.39844 16.5 -3.23633 -19.9844 31.125 -5.69922 -13.9922 10.2422 -1.27637 4.75781 -17.3125 15.9844 0.243652 0.269531 -16.8438 -12.8281 20
```
